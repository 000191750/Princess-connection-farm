# Schedule 计划 使用帮助

: 2020-08-31 By TheAutumnOfRice：增加了Schedule总览部分  

## 1. Schedule总览

一款只能执行特定任务脚本不是一个好脚本。一款优秀的脚本，可以方便地指派某些账号去做某些任务，甚至可以方便地指定一个“计划”，在“账号做
任务”的基础上，增加“什么时候账号做任务”的功能。在本脚本中，schedule系统就实现了以上功能。

### 1.1 创建用户

一个用户，被称为`user`，具有用户名和密码两条基本属性，它可以在控制台中通过`user`族命令创建。这是执行计划的最基本元素之一，请首先
买30~40个小号，然后将它们创建吧！

不妨假设，我们想要执行单公会的小号送mana功能，那么我们需要首先准备一个大号，5个装备号，外加24个mana号。也就是说，我们一共有30个号。
每一个号，都有一个对应的账号和密码。在main_new.py的同一目录下创建一个`zhanghao.txt`的文本文件，在里面按照“用户 （空格） 密码“的形式把三十行号
输进去吧！（实际使用时请将“dahao”替换成你大号的账号，“dahao_pwd”替换为你大号的密码，其它同理哦。

```
dahao dahao_pwd
zhuangbei1 zhaungbei1_pwd
...
zhuangbei5 zhuangbei5_pwd
mana1 mana1_pwd
...
mana24 mana24_pwd
```

接下来，使用`python main_new.py`打开控制台，输入`edit`进入配置编辑模式，再输入以下指令从文件中导入用户：

```
user -c -file zhanghao.txt 
```

注：可以输入`user?`命令查看更多关于用户的操作方式。

此时，我们的用户就创建好啦，在控制台输入`user -l`查看下效果吧，屏幕上将显示30行的账号XXXX加载完成。
被加载的用户会以json的形式存储在`/users`文件夹中，可以进入查看，我们将看到有30个文件名为用户名的文本文件，随便点开一个，观察到
用户名和密码已经输入完毕。

### 1.2 创建用户组

一个用户组，被称作`group`。很多时候，我们需要对很多账号做同样的操作，如果输入类似如下的命令，就会非常麻烦：

```
装备号1 做 捐装备
装备号2 做 捐装备
装备号3 做 捐装备
装备号4 做 捐装备
装备号5 做 捐装备
```

我们希望可以输入`全部装备号 做 捐装备`类似的命令方式，就可以实现上面的效果。因此，我们需要把这种号全部编组。

首先，我们在根目录下（与main_new.py同一目录）创建一个文件夹`/groups`，在其中新建一个文本文件，文件名为`zhuangbei.txt`。
虽然理论上支持中文，不过为了保险起见，尽量全部使用字母吧。创建完成后，我们在其中写五行，每行一个账号名：

```
zhuangbei1
zhuangbei2
zhuangbei3
zhuangbei4
zhuangbei5
```

这样，我们就建了一个名叫`zhuangbei`的组，在配置控制台中，输入`group -l`，将会查看到刚刚创建的组的信息。
还可以通过`group zhuangbei`命令，查看zhuangbei组内的成员。如果没有产生错误，说明这个组已经建立成功啦。

同理，我们建立一个`mana`的组，并且把24个mana号的账号写入文件，使用`group mana`命令确认组创建成功。

### 1.3 创建任务

任务，`task`，是用户自定义的，一串子脚本的列表。比如，一个mana的脚本顺序可能包含以下流程：

行会点赞 -> 地下城借人 -> 刷1-1拿经验

定义好这样的task后，我们就可以告诉脚本`mana组执行mana脚本`来执行既定的计划啦。

首先，进入配置控制台，通过`task -c mana`命令，创建一个名字为mana的任务。
然后，用`task -e mana`命令，进入mana任务的编辑模式。在编辑模式中，你可以随时输入`help`查看使用帮助。

第一个要添加的任务是行会点赞，这是一个行会相关的任务。查看help得知，查看所有行会相关的任务代码，需要使用`list -h`命令。
在控制台输入该命令，查找发现行会点赞的命令缩写是`h6`。

接下来，我们添加这个命令。在控制台输入`add h6`，进入行会点赞的添加流程。很多命令有具体的实现细节，我们只需要跟着命令行提示
一步一步进行即可。此时，命令行提示我们输入一个0或1的整数，我们想给战力最高的人点赞，于是这里输入1然后回车。

这样，第一个任务就创建完毕了。可以输入`show`命令，发现刚刚创建的任务已经添加成功了。
注意，此时任务还属于未保存的状态，如果需要保存任务，必须输入`save`。及时保存是好习惯哦。

用同样的方法，把剩下两个子任务依次添加进mana中。然后，`save`,`exit`，至此一个mana号的任务就创建完毕了。

任务文件被保存在`/tasks`文件夹下，我们将找到之前定义的`mana.txt`文件，点进查看。该任务通过json的方式存储，其中用
`type`关键字表示该任务的缩写，而其余的均为该任务的参数。目前的控制台不能很好地做到任务的编辑，如果需要编辑任务的参数，
可以手动打开task文件，然后调换顺序，修改参数等。修改结束后，建议先在控制台中输入`task mana`命令查看该任务的详情，检查
编辑情况，若弹出错误，则说明该任务文件非法，按照提示修改即可。

同理，创建完mana任务后，再接着创建一个捐赠装备的juanzeng任务吧！至于大号的任务，这里先不赘述，将在介绍完schedule后进一步介绍。

### 1.4 创建批配置

批，`batch`，如字面意思，为一批任务的集合。在这之前，我们已经定义了`user`,`group`,`task`。现在，我们需要一个“谁做谁”的方法，
指定谁做谁的方法文件就是`batch`。

在一个batch中，我们可以只指定某user执行某task，也可以指定user1执行task1，user2执行task2，也可以执行user1执行task1，group1执行taskgroup……
比如，我们可能希望写一个做日常任务的脚本，大号的日常任务和小号的日常任务不同，那么我们可以写一个`batch`，在里面指定大号做
大号的日常，小号做小号的日常。这样，我们只要执行这个batch，一系列“谁做谁”的任务就进入任务队列啦。

不过，即使是这样，我们还会不满意。因为，也许我们希望脚本在一堆日常任务中，优先执行大号的日常任务，而小号的日常任务需求不大，可以延后
执行。所以，我们还可以在一个batch中对每一个子任务指定优先级`priority`。优先级默认为0，高优先级的任务将优先执行。

在1.3中，我们已经创建了mana任务和zhuangbei任务。一般而言，装备捐赠和mana任务应该是独立的。因为它们的触发条件不同。捐赠mana应该在
大号放上支援后进行，每天只进行一次；而装备任务是在大号发起装备捐赠后执行，每天可执行三次。关于执行条件的制定和24h挂机，将在schedule中介绍。
此处，我们先创建两个独立的batch，每个batch中只有一条“谁做谁”的任务，即我们可以创建批”zhuangbei“，里面写上”装备号执行捐赠装备“；
再创建批”mana“，里面写上”mana号执行捐赠mana“。

以上都是思路，具体操作如下。首先，在配置控制台中，输入`batch -c zhuangbei`创建一个装备号的`batch`。
然后，输入`batch -e zhuangbei`进入该batch的编辑模式。输入`help`可以查看详细帮助。

此处，让我们添加一个”装备号捐装备“的子任务吧！由于之前已经创建了名为`zhuangbei`的`group`以及名为`zhuangbei`的`task`。
于是只需要输入`add -g zhuangbei zhuangbei`即可。输入`show`查看结果，然后`save`，`exit`，完成一次创建。

在目录`/batches`中可以看到我们之前建立的批配置，点进去查看一下，发现录入成功了。

同理，继续创建一个名为`mana`的”玛娜号执行捐赠mana“的batch吧！

### 1.5 创建计划

计划，`schedule`，为上述四元素的最高层控制信息。`batch`通过控制user或group与task的关系实现了”谁干什么“，但有很多个batch的时候，
我们执行哪一个呢？什么时候执行什么batch呢？这些都要交给schedule来处理了。

schedule能干的事情有很多。如，希望一个号早上、晚上执行不同的batch，那么可以通过设置条件为”指定时间段启动“；或者希望大号一日三捐，想自动捐赠，
那么可以通过设置条件为“可以捐赠时启动”。如果想执行40to1，那么它需要六个batch依次执行
（公会1小号捐赠->公会1会长踢大号->大号加入公会2->公会2小号捐赠->公会2会长踢大号->大号加入公会1），类似这种依次执行batch的需求也可以在
schedule中实现。

此处，我们只介绍最简单的功能，熟悉创建计划的流程。接下来，我们先创建一个捐赠装备的schedule。该schedule没有任何条件，它包含的信息仅仅是：
当该schedule被执行时，立刻执行juanzeng的batch。也许就这样看来说，使用schedule有些多此一举了。目前看来可能确实是这样，因为现在
没有GUI，很多方便的功能没法使用（比如，在执行mana捐赠schedule的同时，突然想要中途执行zhuangbei的batch。使用GUI就可以做到这一点，但
控制台下，没有办法在程序运行的同时输入东西呀）。所以，必须单独写一个schedule出来。不过schedule还集成了其它优秀的方法，仅以此例，抛砖引玉。

首先，在控制台中输入`schedule -c zhuangbei`，创建一个名为zhuangbei的计划。然后输入`schedule -e zhuangbei`，进入编辑模式。

输入help，可以发现，有三种类型的子计划可以创建。`asap`计划为立即执行的计划。该计划意思是：如果满足条件，则立即执行，否则该计划将被跳过。
`wait`计划为等待执行计划，该计划意思是：如果满足条件，则立即执行，否则程序将一直运行直到触发条件位置。`config`为对整个计划的其它配置。

比如，我有两个batch，分别为上午任务与晚上任务。如果都设置为asap，那么如果上午运行程序，晚上任务将会被跳过，执行上午脚本结束后脚本将退出。
如果都设置为wait，那么如果上午运行程序，晚上任务会进入“等待执行”状态，执行上午脚本结束后，脚本不会退出，将一直等待执行到下午脚本执行完毕为止。
一般来说，如果要设置24小时挂机，那么wait是一个良好的选择；如果仅仅是希望执行一次性的任务，那么也可以使用asap。

此处，我们创建的zhuangbei为一个一次性的任务，输入`add asap`，进入配置引导。首先给这个子任务起一个名字，不妨叫zhuangbei。
目前，假设我们希望大号是手动操作，发起捐赠后，手动执行小号的捐赠脚本，那么该子计划就只包含一个批，即前面已经创建的zhuangbei，此处输入0。
如果希望大号自动发起捐赠，则可以再写一个大号发起捐赠的batch，然后依次执行大号发起捐赠与小号捐装备的batch，此处就应该输入1。

简单起见，此处我们采用第一种方案，输入0。然后，输入zhuangbei，这是之前写好的批配置文件。我们不需要任何条件，输入0退出设置。关于记录方面，
也不需要特殊设置，选择默认的0，正常运行即可。此时，我们就成功创建了一个子计划，输入`show`查看当前的计划情况，可以发现，我们已经在
名为zhuangbei的计划中，建立了名叫zhuangbei的子计划，该子计划为立即执行，将执行名为zhuangbei的批配置。该批配置的内容为让组zhuangbei中的
全部号执行名为zhuangbei的task。

创建完毕，输入`save`，`exit`。此时，user,group,task,batch,schedule，从最初的用户到最终的计划，我们终于完成了一个计划的配置全流程。

schedule文件保存在`/schedules`中，同样，可以进入查看，并且进行修改等操作。

同样，我们可以再创建另一个名为mana的计划，用来立即执行名为mana的batch。

### 1.6 计划启动

假设我们已经在大号上发起了装备捐赠请求，下面让我们进入python main_new.py，在主控制台开启任务吧！

提前打开好模拟器，接着只需要输入`first zhuangbei`，即可执行刚刚建好的名为zhuangbei的计划。如果中途脚本出错关闭，再次进入时想
从上次的进度恢复，则输入`continue zhuangbei`即可。

想知道某一个schedule的进行情况，可以输入`state zhuangbei`查看。它将显示每一个子计划的完成情况。
如果脚本运行中遇到错误，此batch中出错的账号将无法继续运行，即使使用first命令也没有用。因为出现的错误很可能是脚本的BUG，所以一定要
人为处理或者进行错误的上报。出错的账号及任务会显示在state中，在`/log`文件夹下能找到对应的日志（`遗书`)，在`/error_screenshot`文件夹下能找到
脚本崩溃前最后一张截图的存档（`遗照`）。欢迎将遗书与遗照反馈给开发者，以便脚本更好的发展！

错误解决后，想要恢复脚本的运行，只需要输入`clear zhuangbei -all`即可，它将清除zhuangbei计划中所有子计划的错误信息，此时再continue，就能
继续跑脚本了。

# 敬请期待

以下功能已经可以实现，有能力者可以先行探索解决方案，帮助会陆续更新，敬请期待。

- [ ] 如何配置Server酱
- [ ] 如何配置OCR
- [ ] 如何配置自动启动模拟器和闲置关闭模拟器
- [ ] 如何配置运行结束后自动关机（功能开发中）
- [ ] 40to1的Schedule编写教程
- [ ] 自动装备捐赠的Schedule编写教程
- [ ] 如何写一个24小时计划脚本
